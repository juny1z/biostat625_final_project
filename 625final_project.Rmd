---
title: "625final"
author: "JUNYI ZHANG, Yanan Fang"
date: "2025-12-05"
output: pdf_document
---

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(tigris) 
library(sf) 
library(ggplot2) 
library(broom)  
library(caret)


Prevalence <- read_csv("DiabetesPrevalence_CountyData.csv", skip=2)
Incidence <- read_csv("DiabetesIncidence_CountyData.csv", skip=2)
Obesity <- read_csv("Diabetes_Obesity_CountyData.csv", skip=2)
Physical_Inactivity <- read_csv("DiabetesP_inactivity_CountyData.csv", skip=2)
Demography <- read_csv("ACSDP5Y2023.DP05-Data_demography.csv")
Socioeconomic <- read_csv("analytic_data2025_v3.csv")
```

```{r}
library(dplyr)
#clean data
Prevalence_clean <- Prevalence %>%
  mutate(
    CountyFIPS = as.integer(CountyFIPS),
    Percentage = na_if(Percentage, "No Data"),
    Percentage = as.numeric(Percentage)
  ) %>%
  dplyr::select(County, State, CountyFIPS, prevalence_pct = Percentage)

Incidence_clean <- Incidence %>%
  mutate(
    CountyFIPS = as.integer(CountyFIPS),
    `Rate per 1000` = na_if(`Rate per 1000`, "No Data"),
    `Rate per 1000` = as.numeric(`Rate per 1000`)
  ) %>%
  dplyr::select(County, State, CountyFIPS, incidence_rate = `Rate per 1000`)

Obesity_clean <- Obesity %>%
  mutate(
    CountyFIPS = as.integer(CountyFIPS),
    Percentage = na_if(Percentage, "No Data"),
    Percentage = as.numeric(Percentage)
  ) %>%
  dplyr::select(County, State, CountyFIPS, obesity_pct = Percentage)

Physical_Inactivity_clean <- Physical_Inactivity %>%
  mutate(
    CountyFIPS = as.integer(CountyFIPS),
    Percentage = na_if(Percentage, "No Data"),
    Percentage = as.numeric(Percentage)
  ) %>%
  dplyr::select(County, State, CountyFIPS, inactivity_pct = Percentage)

County_data_all <- Obesity_clean %>%
  full_join(Physical_Inactivity_clean,
            by = c("County", "State", "CountyFIPS")) %>%
  full_join(Incidence_clean,
            by = c("County", "State", "CountyFIPS")) %>%
  full_join(Prevalence_clean,
            by = c("County", "State", "CountyFIPS"))
head(County_data_all)


#plot
library(ggplot2)
plot_obesity_prev <- County_data_all %>%
  filter(!is.na(obesity_pct),
         !is.na(prevalence_pct))

plot_obesity_prev <- County_data_all %>%
  filter(!is.na(obesity_pct),
         !is.na(prevalence_pct))
ggplot(plot_obesity_prev,
       aes(x = obesity_pct, y = prevalence_pct)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "Obesity (%)",
    y = "Diabetes Prevalence (%)",
    title = "County-level Obesity vs. Diabetes Prevalence"
  ) +
  theme_minimal()
plot_inact_prev <- County_data_all %>%
  filter(!is.na(inactivity_pct),
         !is.na(prevalence_pct))

ggplot(plot_inact_prev,
       aes(x = inactivity_pct, y = prevalence_pct)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "Physical Inactivity (%)",
    y = "Diabetes Prevalence (%)",
    title = "County-level Physical Inactivity vs. Diabetes Prevalence"
  ) +
  theme_minimal()
plot_obesity_incid <- County_data_all %>%
  filter(!is.na(obesity_pct),
         !is.na(incidence_rate))

ggplot(plot_obesity_incid,
       aes(x = obesity_pct, y = incidence_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "Obesity (%)",
    y = "Diabetes Incidence (per 1000)",
    title = "County-level Obesity vs. Diabetes Incidence"
  ) +
  theme_minimal()
plot_inact_incid <- County_data_all %>%
  filter(!is.na(inactivity_pct),
         !is.na(incidence_rate))

ggplot(plot_inact_incid,
       aes(x = inactivity_pct, y = incidence_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "Physical Inactivity (%)",
    y = "Diabetes Incidence (per 1000)",
    title = "County-level Physical Inactivity vs. Diabetes Incidence"
  ) +
  theme_minimal()
```

```{r diabetes-map, message=FALSE, warning=FALSE, fig.width=16, fig.height=6, dpi=300}
library(dplyr)
library(ggplot2)
library(sf)
library(tigris)
library(viridis)
options(tigris_use_cache = TRUE)
County_data_all <- County_data_all %>%
  mutate(fips = sprintf("%05d", CountyFIPS))
counties_sf <- counties(class = "sf", cb = TRUE, year = 2020)
map_data_all <- counties_sf %>%
  left_join(County_data_all, by = c("GEOID" = "fips"))
ggplot(map_data_all) +
  geom_sf(aes(fill = prevalence_pct), color = NA, size = 0) +
  scale_fill_viridis_c(
    option = "magma",
    na.value = "grey90",
    name = "Diabetes prevalence (%)"
  ) +
  coord_sf(crs = 5070, datum = NA) +  
  labs(
    title = "County-level Diabetes Prevalence Across the United States"
  ) +
  theme_void(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )
```

```{r}
library(tidyverse)
## ---- Clean and extract selected demographic variables ----
demo_clean <- Demography %>% 
  transmute(
    GEO_ID, 
    CountyFIPS = as.integer(str_sub(GEO_ID, -5L)),
    County     = NAME,
    total_pop      = DP05_0001E,  
    median_age     = DP05_0018E,  
    perc_65plus    = DP05_0024PE, 
    perc_black     = DP05_0070PE,  
    perc_hispanic  = DP05_0071PE  
  ) %>% 
  slice(-1) %>% 
  # Remove national- or state-level rows with missing FIPS codes
  filter(!is.na(CountyFIPS) & CountyFIPS != "")


## ---- Clean Socioeconomic variables ----
socio_clean <- Socioeconomic %>%
  transmute(
    CountyFIPS = as.integer(`5-digit FIPS Code`),
    County     = Name,
    State      = `State Abbreviation`,

    income_raw    = `Median Household Income raw value`,
    education_raw = `Some College raw value`,
    poverty_raw   = `Children in Poverty raw value`
  ) %>%
  mutate(
    income    = readr::parse_number(income_raw),
    education = readr::parse_number(education_raw),
    poverty   = readr::parse_number(poverty_raw)
  ) %>%
  select(-income_raw, -education_raw, -poverty_raw) %>%
  filter(!is.na(CountyFIPS))

```


```{r}
# data merge
County_data <- Obesity_clean %>%
  full_join(Physical_Inactivity_clean,
            by = c("County", "State", "CountyFIPS")) %>%
  full_join(Incidence_clean,
            by = c("County", "State", "CountyFIPS")) %>%
  full_join(Prevalence_clean,
            by = c("County", "State", "CountyFIPS")) %>%
  full_join(socio_clean %>% select(-County, -State),
            by = "CountyFIPS") %>%
  full_join(demo_clean  %>% select(-County),
            by = "CountyFIPS")

```
```{r}
## Pairwise relationship scatterplots
# 1. Income vs Diabetes Prevalence
plot_income_prev <- County_data %>%
  filter(!is.na(income), !is.na(prevalence_pct))

ggplot(plot_income_prev,
       aes(x = income, y = prevalence_pct)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "Median Household Income ($)",
    y = "Diabetes Prevalence (%)",
    title = "Income vs Diabetes Prevalence"
  ) +
  theme_minimal()

# 2. Education vs Diabetes Prevalence
plot_edu_prev <- County_data %>%
  filter(!is.na(education), !is.na(prevalence_pct))

ggplot(plot_edu_prev,
       aes(x = education, y = prevalence_pct)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "% Adults with Some College",
    y = "Diabetes Prevalence (%)",
    title = "Education vs Diabetes Prevalence"
  ) +
  theme_minimal()

# 3. Poverty vs Diabetes Prevalence
plot_poverty_prev <- County_data %>%
  filter(!is.na(poverty), !is.na(prevalence_pct))

ggplot(plot_poverty_prev,
       aes(x = poverty, y = prevalence_pct)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "% Children in Poverty",
    y = "Diabetes Prevalence (%)",
    title = "Poverty vs Diabetes Prevalence"
  ) +
  theme_minimal()


# 4. Income vs Diabetes Incidence
plot_income_incid <- County_data %>%
  filter(!is.na(income), !is.na(incidence_rate))

ggplot(plot_income_incid,
       aes(x = income, y = incidence_rate)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "Median Household Income ($)",
    y = "Diabetes Incidence (per 1000)",
    title = "Income vs Diabetes Incidence"
  ) +
  theme_minimal()

# 5. Education vs Diabetes Incidence
plot_edu_incid <- County_data %>%
  filter(!is.na(education), !is.na(incidence_rate))

ggplot(plot_edu_incid,
       aes(x = education, y = incidence_rate)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "% Adults with Some College",
    y = "Diabetes Incidence (per 1000)",
    title = "education vs Diabetes Incidence"
  ) +
  theme_minimal()

# 6. Poverty vs Diabetes Incidence
plot_poverty_incid <- County_data %>%
  filter(!is.na(poverty), !is.na(incidence_rate))

ggplot(plot_poverty_incid,
       aes(x = poverty, y = incidence_rate)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    x = "% Children in Poverty",
    y = "Diabetes Incidence (per 1000)",
    title = "Poverty vs Diabetes Incidence"
  ) +
  theme_minimal()

```

```{r}
# Model for prevalence
model_prev <- lm(prevalence_pct ~ income + education + poverty +
                   obesity_pct + inactivity_pct,
                 data = County_data)

summary(model_prev)

# Model diagnostics for prevalence model
library(ggfortify)
autoplot(model_prev)
# VIF
library(car)
vif(model_prev)


## Model for incidence
model_incid <- lm(incidence_rate ~ income + education + poverty +
                    obesity_pct + inactivity_pct,
                  data = County_data)

summary(model_incid)
# Model diagnostics for prevalence model
autoplot(model_incid)
# VIF
vif(model_incid)
```
```{r model-comparison, message=FALSE, warning=FALSE}
analysis_prev <- County_data %>%
  dplyr::select(prevalence_pct, income, education, poverty,
                obesity_pct, inactivity_pct) %>%
  filter(across(everything(), ~ !is.na(.)))

m_ses  <- lm(prevalence_pct ~ income + education + poverty,
             data = analysis_prev)
m_beh  <- lm(prevalence_pct ~ obesity_pct + inactivity_pct,
             data = analysis_prev)
m_full <- lm(prevalence_pct ~ income + education + poverty +
                           obesity_pct + inactivity_pct,
             data = analysis_prev)

AIC(m_ses, m_beh, m_full)
BIC(m_ses, m_beh, m_full)

cv_rmse_lm <- function(formula, data, k = 10, seed = 625) {
  set.seed(seed)
  n <- nrow(data)
  folds <- sample(rep(1:k, length.out = n))
  rmse_vec <- numeric(k)
  
  for (i in 1:k) {
    train_dat <- data[folds != i, , drop = FALSE]
    test_dat  <- data[folds == i, , drop = FALSE]
    
    fit_i <- lm(formula, data = train_dat)
    pred_i <- predict(fit_i, newdata = test_dat)
    
    rmse_vec[i] <- sqrt(mean((test_dat$prevalence_pct - pred_i)^2))
  }
  mean(rmse_vec)
}

cv_ses  <- cv_rmse_lm(prevalence_pct ~ income + education + poverty,
                      data = analysis_prev)
cv_beh  <- cv_rmse_lm(prevalence_pct ~ obesity_pct + inactivity_pct,
                      data = analysis_prev)
cv_full <- cv_rmse_lm(prevalence_pct ~ income + education + poverty +
                                    obesity_pct + inactivity_pct,
                      data = analysis_prev)

model_comp <- tibble::tibble(
  model = c("Socioeconomic only",
            "Behavioral only",
            "Full model"),
  AIC  = c(AIC(m_ses),  AIC(m_beh),  AIC(m_full)),
  BIC  = c(BIC(m_ses),  BIC(m_beh),  BIC(m_full)),
  CV_RMSE = c(cv_ses, cv_beh, cv_full)
)

model_comp
```

```{r spatial-analysis, message=FALSE, warning=FALSE}
library(spdep)
library(dplyr)
library(sf)
library(ggplot2)

sp_data <- map_data_all %>%
  filter(!is.na(prevalence_pct)) %>%
  st_make_valid()  

nb <- poly2nb(sp_data, queen = TRUE)
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)

moran_prev <- moran.test(sp_data$prevalence_pct, lw, zero.policy = TRUE)
moran_prev   


sp_data$lag_prev <- lag.listw(lw, sp_data$prevalence_pct, zero.policy = TRUE)

local_moran <- localmoran(sp_data$prevalence_pct, lw, zero.policy = TRUE)

p_col <- grep("^Pr", colnames(local_moran), value = TRUE)
sp_data$Ii        <- local_moran[, "Ii"]
sp_data$Ii_pvalue <- local_moran[, p_col]


mean_prev <- mean(sp_data$prevalence_pct, na.rm = TRUE)
mean_lag  <- mean(sp_data$lag_prev, na.rm = TRUE)

sp_data <- sp_data %>%
  mutate(
    high_prev = prevalence_pct > mean_prev,
    high_lag  = lag_prev > mean_lag,
    cluster = case_when(
      Ii_pvalue >= 0.05 ~ "Not significant",
      high_prev & high_lag  ~ "High-High",
      !high_prev & !high_lag ~ "Low-Low",
      high_prev & !high_lag ~ "High-Low",
      !high_prev & high_lag ~ "Low-High",
      TRUE ~ "Not significant"
    ),
    cluster = factor(
      cluster,
      levels = c("High-High", "Low-Low", "High-Low", "Low-High", "Not significant")
    )
  )
ggplot(sp_data) +
  geom_sf(aes(fill = cluster), color = NA, size = 0) +
  scale_fill_manual(
    values = c(
      "High-High"      = "#d73027",
      "Low-Low"        = "#4575b4",
      "High-Low"       = "#fdae61",
      "Low-High"       = "#74add1",
      "Not significant" = "grey90"
    ),
    drop = FALSE,
    name = "LISA cluster"
  ) +
  coord_sf(crs = 5070, datum = NA) +
  labs(
    title = "Local clusters of county-level diabetes prevalence"
  ) +
  theme_void(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    legend.title = element_text(size = 12),
    legend.text  = element_text(size = 10)
  )
```
